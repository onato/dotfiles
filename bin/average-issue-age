#!/bin/bash

# Check if jq is installed
if ! command -v jq &>/dev/null; then
  echo "jq could not be found, please install it to proceed."
  exit
fi

# Jira credentials and URL
JIRA_URL="https://$JIRA_DOMAIN"
JIRA_USER="$JIRA_USERNAME"
JIRA_API_TOKEN="$JIRA_API_TOKEN"

# Prepare data files for gnuplot
issue_data_file="issue_data.dat"
age_data_file="age_data.dat"
echo "# Month IssueCount" >$issue_data_file
echo "# Month AverageAge" >$age_data_file

for month_offset in {16..0}; do
  # Calculate the month name for the current offset
  month_name=$(date -v-${month_offset}m "+%B")
  JQL="type = Bug and project not in (DES, VUL, JS, SQP, SEC, SES, SYS) AND priority = P3 AND status WAS NOT IN (\"Resolved\", \"Closed\", \"Done\", \"Won't do\") DURING (startOfMonth(-$month_offset), endOfMonth(-$month_offset)) AND created <= endOfMonth(-$month_offset)"

  # URL encode the JQL
  encoded_jql=$(jq -rn --arg jql "$JQL" '$jql|@uri')

  start_at=0
  total_days=0
  issue_count=0

  while true; do
    # Fetch issues from Jira using the encoded JQL
    response=$(curl -s -u $JIRA_USER:$JIRA_API_TOKEN -X GET -H "Content-Type: application/json" \
      "$JIRA_URL/rest/api/3/search?jql=$encoded_jql&fields=created&maxResults=100&startAt=$start_at")

    # echo curl -s -u $JIRA_USER:$JIRA_API_TOKEN -X GET -H "Content-Type: application/json" \
    #   "$JIRA_URL/rest/api/3/search?jql=$encoded_jql&fields=created&maxResults=100&startAt=$start_at"

    issues=$(echo $response | jq -c '.issues[]')
    if [ -z "$issues" ]; then
      break
    fi

    for issue in $issues; do
      created=$(echo $issue | jq -r '.fields.created')
      issue_key=$(echo $issue | jq -r '.key')
      created_date=$(date -u -j -f "%Y-%m-%dT%H:%M:%S" "${created:0:19}" "+%s")
      current_date=$(date -v-${month_offset}m -v1d -v+1m "+%s")
      days_open=$(((current_date - created_date) / 86400))
      total_days=$((total_days + days_open))
      issue_count=$((issue_count + 1))
      issue_url="$JIRA_URL/browse/$issue_key"
      # echo -e "Issue $issue_key has been open for $days_open days. \t\t$issue_url"
    done

    start_at=$((start_at + 100))
  done

  if [ $issue_count -eq 0 ]; then
    echo "No issues found for month offset $month_offset."
  else
    average_days=$(echo "scale=2; $total_days / $issue_count" | bc)
    echo "Month: $month_name, Issues found: $issue_count, Average time issues have been open: $average_days days"
  fi
  echo "$month_name $issue_count" >>$issue_data_file
  echo "$month_name $average_days" >>$age_data_file
done

# Generate graphs using gnuplot
gnuplot -e "set terminal png size 800,600; set output 'issue_count.png'; set title 'Number of Issues per Month'; set xlabel 'Month'; set ylabel 'Issue Count'; set xtics rotate; plot '$issue_data_file' using 2:xtic(1) with linespoints title 'Issues';"
gnuplot -e "set terminal png size 800,600; set output 'average_age.png'; set title 'Average Issue Age per Month'; set xlabel 'Month'; set ylabel 'Average Age (days)'; set xtics rotate; plot '$age_data_file' using 2:xtic(1) with linespoints title 'Average Age';"

# Generate combined graph using gnuplot
gnuplot -e "set terminal png size 800,600; set output 'combined_graph.png'; set title 'Issues and Average Age per Month'; set xlabel 'Month'; set ylabel 'Count / Average Age'; set y2label 'Average Age (days)'; set ytics nomirror; set y2tics; set xtics rotate; plot '$issue_data_file' using 2:xtic(1) with linespoints title 'Issues' axis x1y1, '$age_data_file' using 2:xtic(1) with linespoints title 'Average Age' axis x1y2;"

echo "Graphs generated: issue_count.png, average_age.png, and combined_graph.png"
